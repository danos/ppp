#!/usr/bin/make -f
# -*- mode: makefile; coding: utf-8 -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# Activate full hardening build flags minus PIE which breaks plugins
export DEB_BUILD_MAINT_OPTIONS := hardening=+all,-pie

D := $(CURDIR)/debian/ppp

# plugin ABI version, part of the directory name
# shell expression from pppd/plugins/Makefile.linux
PPPDDIR := $(shell awk -F '"' '/VERSION/ { print $$2; }' $(CURDIR)/pppd/patchlevel.h)

##############################################################################
%:
	dh $@ --with systemd

override_dh_auto_clean:
	rm -rf pppd-udeb changelog-from-README
	[ ! -f Makefile ] || $(MAKE) dist-clean

override_dh_auto_configure:
	./configure --prefix=/usr
	if [ ! -d pppd-udeb/ ]; then \
		mkdir pppd-udeb/ && \
		cp -ldpR pppd/* pppd-udeb/; \
	fi
	cd pppd-udeb/ && make clean
	cd pppd-udeb/plugins/ && make clean
	perl -i -pe 's/ -DIPX_CHANGE\b//' pppd-udeb/Makefile

changelog-from-README:
	{ \
	  sed -e "/^What's new in ppp-/,/^. New hooks have been added./!d" README ; \
	  echo ; \
	  echo ; \
	  cat Changes-2.3 ; \
	} > changelog-from-README

override_dh_auto_build-arch: changelog-from-README
	dh_auto_build -- \
		COPTS="$(CFLAGS) $(CPPFLAGS)" LDOPTS="$(LDFLAGS)"
	dh_auto_build -Dpppd-udeb/ -- \
		COPTS="$(CFLAGS) $(CPPFLAGS) -Os -fomit-frame-pointer" \
		LDOPTS="$(LDFLAGS)" \
		CHAPMS= USE_CRYPT= NO_CRYPT_HACK=1 MPPE= \
		FILTER= HAVE_MULTILINK= USE_TDB= \
		HAS_SHADOW= USE_PAM= HAVE_INET6= \
		CBCP= USE_SRP= MAXOCTETS= USE_BUILTIN_CRYPTO=1
	dh_auto_build -Dpppd-udeb/plugins \
		COPTS="$(CFLAGS) $(CPPFLAGS) -Os -fomit-frame-pointer" \
		LDOPTS="$(LDFLAGS)" \
		SUBDIRS='rp-pppoe pppoatm' PLUGINS=

override_dh_auto_build-indep: changelog-from-README

override_dh_auto_install-arch:
	dh_auto_install -- DESTDIR=$D/usr/
	rm -rf $D/usr/include/

	rm -rf $D/etc/ppp/*-secrets

	install -m755 debian/extra/pon debian/extra/plog debian/extra/poff $D/usr/bin/
	cp debian/extra/pon.completion $D/etc/bash_completion.d/pon

	cp debian/extra/options $D/etc/ppp/
	install -m755 debian/extra/ip-up debian/extra/ip-down debian/extra/ipv6-up debian/extra/ipv6-down \
		$D/etc/ppp/
	install -m755 debian/extra/0000usepeerdns-up $D/etc/ppp/ip-up.d/0000usepeerdns
	install -m755 debian/extra/0000usepeerdns-down \
		$D/etc/ppp/ip-down.d/0000usepeerdns

	install -m644 debian/extra/pap-secrets debian/extra/chap-secrets \
		debian/extra/provider.peer debian/extra/provider.chatscript \
		$D/usr/share/ppp/
	install -m644 debian/extra/chatscript.pap $D/etc/chatscripts/pap
	install -m644 debian/extra/chatscript.gprs $D/etc/chatscripts/gprs

	grep '^[a-zA-Z0-9]' debian/extra/options | grep -v '^noipx' \
		> $D-udeb/etc/ppp/options
	cp pppd-udeb/pppd $D-udeb/usr/sbin/
	cp pppd-udeb/pppd pppd-udeb/plugins/rp-pppoe/pppoe-discovery \
		$D-udeb/usr/sbin/
	mkdir -p $D-udeb/usr/lib/pppd/$(PPPDDIR)/
	cp pppd-udeb/plugins/rp-pppoe/rp-pppoe.so \
		pppd-udeb/plugins/pppoatm/pppoatm.so \
		$D-udeb/usr/lib/pppd/$(PPPDDIR)/
	install -m755 debian/extra/ppp-udeb.ip-up $D-udeb/etc/ppp/ip-up
	install -m755 debian/extra/ppp-udeb-postbaseinst \
		$D-udeb/usr/lib/post-base-installer.d/30ppp

override_dh_auto_install-indep:
	$(MAKE) install-devel DESTDIR=$D-dev/usr/

override_dh_installchangelogs:
	dh_installchangelogs changelog-from-README

override_dh_installexamples-arch:
	dh_installexamples scripts/ debian/extra/autopppd debian/extra/userscripts-* \
		debian/extra/popp debian/extra/filters debian/extra/options.ttyXX \
		debian/extra/peers-* debian/extra/interfaces debian/extra/per-linkname

	# use our own version, not the upstream one
	mv $D/usr/share/doc/ppp/examples/autopppd \
		$D/usr/share/doc/ppp/examples/scripts/

override_dh_systemd_enable:
	dh_systemd_enable --name=pppd-dns

override_dh_installinit:
	dh_installinit --name=pppd-dns --no-start

override_dh_systemd_start:
	dh_systemd_start --name=pppd-dns --no-start

override_dh_fixperms-arch:
	dh_fixperms
	chown root:dip $D/usr/sbin/pppd \
		$D/etc/ppp/ $D/etc/ppp/peers/ $D/etc/chatscripts/
	chmod 4754 $D/usr/sbin/pppd
	chmod 2750 $D/etc/ppp/peers/ $D/etc/chatscripts/

get-orig-source:
	cd $(dir $(firstword $(MAKEFILE_LIST)))../ && \
	uscan --rename --force-download --watchfile debian/watch --destdir $(CURDIR)
